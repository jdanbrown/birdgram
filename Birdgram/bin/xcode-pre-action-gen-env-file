#!/bin/bash -eux
#
# An xcode pre-action that generates .env for https://github.com/luggit/react-native-config

# Log env for debugging
env

# cd to Birdgram/
dir="$SRCROOT/.."
cd "$dir"

# Generate .env <- .env.shared + .env.$SCHEME_NAME
env_shared_file=".env.shared"
env_scheme_file=".env.$SCHEME_NAME"
env_file=".env"
(
  echo "++ # From file[$env_shared_file]"
  . "$env_shared_file"
  echo '++ '
  echo "++ # From file[$env_scheme_file]"
  . "$env_scheme_file"
# HACK Very brittle ('++ foo=bar'), but I had trouble finding a better way that allowed chaining vars in .env.* files
) 2>&1 \
  | ack '^\+\+ (export .*)$' --output='$1' \
  >"$env_file"

# XXX Modifying project.pbxproj during the build pre-action causes the build to cancel
# # HACK Manually edit project.pbxproj, since it seems there's no way to feed it variables (unlike Info.plist)
# (
#   . "$env_file"
#   perl -pi -e \
#     's/(\bPRODUCT_BUNDLE_IDENTIFIER\s*=\s*"app\.birdgram\.)birdgram-[^"]+(";)/\1'"$BUNDLE_ID_NAME"'\2/g' \
#     'ios/Birdgram.xcodeproj/project.pbxproj'
# )
